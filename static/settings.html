<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Spotify Downloader</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Spotify Downloader</h1>
            <p class="subtitle">Configuration</p>
        </header>

        <div class="settings-card">
            <div id="status-banner" class="status-banner hidden"></div>

            <form id="config-form" onsubmit="saveConfig(event)">
                <div class="form-group">
                    <label for="spotify_client_id">Spotify Client ID</label>
                    <input type="text" id="spotify_client_id" placeholder="e.g. 8331c05962ab422495f02c3e81ebaba9" autocomplete="off" required>
                    <span class="form-hint">From <a href="https://developer.spotify.com/dashboard" target="_blank">Spotify Developer Dashboard</a></span>
                </div>

                <div class="form-group">
                    <label for="spotify_client_secret">Spotify Client Secret</label>
                    <input type="password" id="spotify_client_secret" placeholder="Enter secret..." autocomplete="off" required>
                    <span class="form-hint">From your Spotify app settings</span>
                </div>

                <div class="form-group">
                    <label for="slskd_api_key">slskd API Key</label>
                    <input type="password" id="slskd_api_key" placeholder="Enter API key..." autocomplete="off" required>
                    <span class="form-hint">Must match the SLSKD_API_KEY in your slskd config</span>
                </div>

                <div class="form-group">
                    <label for="slskd_host">slskd Host <span class="optional">(optional)</span></label>
                    <input type="text" id="slskd_host" placeholder="http://slskd:5030" autocomplete="off">
                    <span class="form-hint">Leave empty for default (http://slskd:5030)</span>
                </div>

                <div class="form-actions">
                    <button type="submit" id="save-btn" class="btn-primary">Save & Connect</button>
                    <a href="/" class="btn-secondary">Back to Downloader</a>
                </div>
            </form>
        </div>

        <div id="health-status" class="health-status">
            <span id="health-dot" class="health-dot"></span>
            <span id="health-text">Checking connection...</span>
        </div>
    </div>

    <script>
        async function loadConfig() {
            try {
                const resp = await fetch("/api/config");
                const data = await resp.json();

                document.getElementById("spotify_client_id").value = data.spotify_client_id || "";
                document.getElementById("slskd_host").value =
                    data.slskd_host !== "http://localhost:5030" ? data.slskd_host : "";

                // Show masked values as placeholders for secrets
                if (data.spotify_client_secret) {
                    document.getElementById("spotify_client_secret").placeholder = data.spotify_client_secret;
                }
                if (data.slskd_api_key) {
                    document.getElementById("slskd_api_key").placeholder = data.slskd_api_key;
                }

                if (data.configured) {
                    showBanner("Connected and configured", "success");
                }
            } catch (e) {
                // Server not reachable
            }
        }

        async function saveConfig(event) {
            event.preventDefault();
            const btn = document.getElementById("save-btn");
            btn.disabled = true;
            btn.textContent = "Saving...";

            const body = {
                spotify_client_id: document.getElementById("spotify_client_id").value.trim(),
                spotify_client_secret: document.getElementById("spotify_client_secret").value.trim(),
                slskd_api_key: document.getElementById("slskd_api_key").value.trim(),
                slskd_host: document.getElementById("slskd_host").value.trim(),
            };

            // Don't send empty secrets (keep existing)
            if (!body.spotify_client_secret) {
                showBanner("Please enter the Spotify Client Secret", "error");
                btn.disabled = false;
                btn.textContent = "Save & Connect";
                return;
            }
            if (!body.slskd_api_key) {
                showBanner("Please enter the slskd API Key", "error");
                btn.disabled = false;
                btn.textContent = "Save & Connect";
                return;
            }

            try {
                const resp = await fetch("/api/config", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(body),
                });

                if (resp.ok) {
                    showBanner("Configuration saved! Redirecting...", "success");
                    setTimeout(() => window.location.href = "/", 1500);
                } else {
                    const err = await resp.json();
                    showBanner(err.detail || "Failed to save config", "error");
                }
            } catch (e) {
                showBanner("Could not connect to server", "error");
            } finally {
                btn.disabled = false;
                btn.textContent = "Save & Connect";
            }
        }

        function showBanner(msg, type) {
            const banner = document.getElementById("status-banner");
            banner.textContent = msg;
            banner.className = `status-banner ${type}`;
            banner.classList.remove("hidden");
        }

        async function checkHealth() {
            const dot = document.getElementById("health-dot");
            const text = document.getElementById("health-text");
            try {
                const resp = await fetch("/api/health");
                const data = await resp.json();
                if (data.slskd_connected) {
                    dot.className = "health-dot ok";
                    text.textContent = "slskd connected";
                } else if (data.status === "not_configured") {
                    dot.className = "health-dot";
                    text.textContent = "Not configured";
                } else {
                    dot.className = "health-dot degraded";
                    text.textContent = "slskd not reachable";
                }
            } catch {
                dot.className = "health-dot degraded";
                text.textContent = "Server offline";
            }
        }

        loadConfig();
        checkHealth();
        setInterval(checkHealth, 30000);
    </script>
</body>
</html>
